%-------------------------------------------------------------------------------
% build
%-------------------------------------------------------------------------------
%
% \file        build.tex
% \library     Documents
% \author      Chris Ahlstrom
% \date        2015-11-06
% \update      2019-08-15
% \version     $Revision$
% \license     $XPC_GPL_LICENSE$
%
%     Provides the man page section of seq24-user-manual.tex.
%
%-------------------------------------------------------------------------------

\section{Building Seq66}
\label{sec:build}

   The project packaging for \textsl{Seq66}
   is (still) aimed at developers.
%  But note that we have Debian packages, conventional tarballs,
%  and \textsl{Windows} installers in the "Seq66
%  Packages" project (\cite{seq66packages}).
%  If one has packages built for other Linux distributions, let us know, and we
%  can stick them there for others to use.

   This section is a how-to on building
   \textsl{Seq66} from source code.  It's easy with
   these instructions. Note that there are many ways to build
   \textsl{Seq66}, each described in its own section.
   \textsl{Seq66} is available only in CLI (command-line) or Qt 5 forms.
   The latter can be built via \textsl{qtcreator} (easy-peasy)
   or via \textsl{GNU Automake}.

\subsection{Linux INSTALL Build}
\label{subsec:build_install}

   There are many build options.  Some are modifiable via the normal GNU
   \texttt{configure} script method.  Some are modifiable by
   editing the source code to \textbf{\#define} and \textbf{\#undefine} certain
   macros.  If you don't care about such options, start here.
   If you want to see what options are available, skip to
   \sectionref{subsubsec:build_configure}, which has many details one can
   adjust.
   The project includes the conventional GNU \texttt{configure} script, in the
   tarball and in the git-cloned project.  However, the
   the \texttt{bootstrap} script can do a lot of setup,
   as in the following instructions:

   \begin{enumber}
      \item Preload the dependencies, as listed in
         \sectionref{subsec:build_dependencies}.
          If some are missing, the
          \texttt{configure} script will tell you,
          or, at worst, a build error will.
      \item Check-out the desired branch, normally "master".
         Make a branch, if desired, to make changes.
         See the file \texttt{git.txt} in the
         \texttt{contrib/notes} project directory.
      \item From the top project directory, run the commands:
\begin{verbatim}
      $ ./bootstrap
      $ ./configure
\end{verbatim}
      \item For debugging without libtool getting in the way, just run
         one of the following commands, which run the
         \texttt{configure} script, adding the
         \texttt{--enable-debug} and
         \texttt{--disable-shared} options to it.
         The bootstrap script is our start-over
         way of setting up GNU autoconf.
\begin{verbatim}
      $ ./bootstrap --enable-debug
      $ ./bootstrap -ed
\end{verbatim}
      \item Run the make command:
\begin{verbatim}
      $ make
\end{verbatim}
      \item To install \textsl{Seq66}, become root and run:
\begin{verbatim}
      # make install
\end{verbatim}
   \end{enumber}

   Note that the Qt user-interface is standard, and the alternate MIDI
   engine, \textsl{portmidi}, can be configured and built, though best for
   \textsl{Windows}.
   See \sectionref{subsec:build_Qt}.

   Note that one has to build the documentation and Debian packaging
   separately, they are not part of the default build.

   The following command bootstraps and then configures
   for release mode, and greatly reduces the amount of compiler output:
 
\begin{verbatim}
   $ ./bootstrap --enable-release
   $ ./bootstrap -er
\end{verbatim}

   This script option runs:

\begin{verbatim}
   $ ./configure --enable-silent-rules
\end{verbatim}

   It results in abbreviated output, which makes it easier to see
   warnings that might pop up.
   This anti-verbosity option can be overridden at "make" time:

\begin{verbatim}
   $ make V=1
\end{verbatim}

   \texttt{V=0} is another way to quiet down the build.
   Note that the build can be sped up by telling \texttt{make}
   to use more cores.
   For example, if one has an 8-core system:

\begin{verbatim}
   $ make -j 8
\end{verbatim}

%  Of course, one can use fewer than the number of cores, if desired.

\subsection{Options for Seq66 Features}
\label{subsec:build_options}

   \textsl{Seq66} comes with options for the \texttt{configure} command
   and options represented by definable macros in the source code.

\subsubsection{"configure" Options}
\label{subsubsec:build_configure}

   The following \texttt{configure} options can be specified on the command
   line.  The default build uses rtmidi and Qt.

   \setcounter{ItemCounter}{0}      % Reset the ItemCounter for this list.

   \itempar{\texttt{--enable-rtmidi}}{build!enable rtmidi}
        \index{BUILD\_RTMIDI}
        This option can be bootstrapped directly using
        "\texttt{./bootstrap -er}.
        This is the default build.
        It creates a Qt executable, \texttt{qseq66},
        which can do JACK MIDI input/output and transport using the native API.
        \texttt{seq66} falls back to using ALSA if JACK is not running.  
        Like ALSA, the JACK support has an auto-connect feature
        that can be disabled using the "manual" ("virtual-port")
        option.

        We term this version "rtmidi" because we originally
        used the RtMidi (\cite{rtmidi}) project as the basis for the native
        JACK support, but it does not quite fit the usage model
        of \textsl{Seq66}, so we heavily refactored it.

   \itempar{\texttt{--enable-cli}}{build!enable cli}
        \index{BUILD\_RTCLI}
        Bootstrapping directly:
        "\texttt{./bootstrap -er -cli}".
        It sets up a command-line build of \texttt{seq66} that has the
        program name \texttt{seq66cli}.
        This application must be controlled via MIDI controls set up in the
        [midi-control] section of the "rc" file.
        See \sectionref{subsec:rc_file_midi_control}, for
        information on those controls, which include start, stop,
        pause, play-list navigation, and other commands.
        A single song can be loaded via the last command-line argument.
        A number of songs can be loaded via a play-list.
        See \sectionref{sec:playlist}.
        There is an option to make
        the application fork into the background as a daemon.
%
%  \itempar{\texttt{--enable-alsamidi}}{build!enable alsamidi}
%       \index{BUILD\_ALSAMIDI}
%       Bootstrapping directly:
%       "\texttt{./bootstrap -er -am}".
%       This executable is basically the original version of 
%       \textsl{Seq66}, with the original executable name of
%       \texttt{seq66}, which we're keeping around as a backup while we
%       work the remaining nits out of the "rtmidi" version of the application.

   \itempar{\texttt{--enable-portmidi}}{build!enable portmidi}
        \index{BUILD\_PORTMIDI}
        Bootstrapping directly:
        "\texttt{./bootstrap -er -pm}".
        This option builds the Linux/PortMIDI version of the application,
        \texttt{seq66portmidi},
        which is is meant as a way to pre-test the
        port to Windows.
        This version is best used for the \textsl{Windows} and
        \textsl{Mac} ports.


    \itempar{\texttt{--disable-jack}}{build!disable jack}
        \index{SEQ66\_JACK\_SUPPORT}
        Undefines the \texttt{SEQ66\_JACK\_SUPPORT} macro, which is
        defined by default.  Even if defined,
        \textsl{Seq66} will still not use JACK support unless
        one specifies the various JACK options on the \texttt{seq66}
        command-line or turn them on in the "rc" configuration file,
        \texttt{\textasciitilde/.config/seq66/qseq66.rc}.
        This is an option for \textsl{Linux} only.

    \itempar{\texttt{--disable-jack-session}}{build!disable jack session}
        \index{SEQ66\_JACK\_SESSION}
        Undefines the \texttt{SEQ66\_JACK\_SESSION} macro, which is
        defined if JACK support is defined, and the
        \texttt{jack/session.h} file is found to be installed on the system.
        This option, if left defined, can be affected by
        command-line options and options in the "rc" configuration file.
        This is an option for \textsl{Linux} only.

    To summarize, these option macros define/undefine the following build
    macros:

      \begin{itemize}
        \item \texttt{SEQ66\_JACK\_SUPPORT}
        \item \texttt{SEQ66\_JACK\_SESSION}
      \end{itemize}

   A lot of options have become mandatory over the years, and are not discussed
   here.  And there may be more macros not discussed.  For the latest, see the
   \texttt{INSTALL} file in the source-code project.

\subsubsection{Manually-defined Macros in the Code}
\label{subsubsec:build_macros}

   As we have explored what \textsl{Seq24} does as we improve
   \textsl{Seq66}, we've found of things that might change the code
   for the worse in some minds.
   We mark those changes with macros.
   And sometimes we tried a change, but left it disabled.
   Look at those macros, modify them, and build
   the source code to one's preferences.
   These macros are described in the \texttt{INSTALL} file.

\subsection{Seq66 Build Dependencies}
\label{subsec:build_dependencies}

   With luck, the following dependencies will bring in their own
   dependencies when installed.  Build requirements:

     \begin{itemize}
%       \item libgtkmm-2.4-dev (dev is the header-file package)
%       \item libsigc++-2.0-dev
        \item libjack-jackd2-dev
        \item liblash-compat-dev (optional)
     \end{itemize}

   Runtime requirements:

     \begin{itemize}
%       \item libatk-adaptor (and its dependencies)
%       \item libgail-common (and its dependencies)
        \item valgrind (optional, very useful for debugging)
        \item gdb (optional, very useful for debugging)
        \item gprof and gcov (optional, useful for debugging)
     \end{itemize}

   Build tools requirements:

     \begin{itemize}
        \item automake and autoconf
        \item autoconf-archive
        \item g++
        \item make
        \item libtool
     \end{itemize}

   Documentation requirements (very optional):

     \begin{itemize}
        \item doxygen and doxygen-latex
        \item graphviz
        \item texlive
        \item latexmk
     \end{itemize}
      
   Debian packaging (optional):

     \begin{itemize}
        \item debhelper
        \item fakeroot
     \end{itemize}

\subsection{Linux Qt Builds}
\label{subsec:build_Qt}

   The \textsl{Linux} version of \textsl{Seq66} can be built with the Qt
   user-interface, using either the PortMIDI or RtMIDI (preferred) MIDI
   engines.
 
\begin{verbatim}
   $ ./bootstrap --enable-release -rm
   $ ./bootstrap -er -rm
\end{verbatim}

   The Qt/RtMIDI combination are the official version
   of \textsl{Seq66} for \textsl{Linux}.
   Our PortMIDI engine, while modestly improved over normal PortMIDI, is not
   quite as complete as the RtMIDI-derived implementation.

\subsection{Linux Qmake Build}
\label{subsec:build_qmake}

   We wanted to build \textsl{Seq66 for Windows} using GNU tools and the
   MSYS platform on either \textsl{Linux} (cross-compiling) or
   \textsl{Windows}.  But it proved easier to create the
   \texttt{*.pro} files necessary for \textsl{qmake} and be able to build
   on \textsl{Windows} and \textsl{Mac OSX}.
   \index{Qt Creator}
   \index{qtcreator}
   This setup and build can be done through \textsl{Qt Creator}.
   The command-line setup is straightforward.
   From the \textsl{Seq66} directory, run the following
   commands, using either the build directory specified by \textsl{Qt Creator},
   or making your own "shadow build" directory.

   \begin{verbatim}
        $ mkdir debug-build
        $ cd debug-build
        $ qmake -makefile -recursive "CONFIG += debug" ../seq66/qpseq66.pro
        $ make
   \end{verbatim}

    One can also use "CONFIG += release", or just leave that off entirely.

    The \texttt{qpseq66.pro} file can also be loaded in the
    nice IDE, \textsl{Qt Creator}, and be configured, built, and debugged
    there.  And one can tweak the GUI elements in that IDE.

\subsection{Windows Qmake Build}
\label{subsec:build_qmake_windows}

   The easiest option for a build on \textsl{Windows} is to install 
   \textsl{Qt Creator} in its open-source edition.
   The executable name is
   \texttt{qt-unified-windows-x86-3.0.5-online.exe} or somesuch.
   Rather than navigate through the corporate pages, just go to
   \url{https://download.qt.io/archive/online_installers/3.0/} and
   pick the latest version.
   
   When installing, be sure to select at least the the 32-bit Mingw tools,
   including \texttt{mingw32-make.exe}, and
   \texttt{qmake.exe}.  The \textsl{Windows}
   \textbf{PATH} must be modified to
   include the path to both executables, and the excutables
   \texttt{moc.exe}, \texttt{uic.exe}, \texttt{rcc.exe}, and
   \texttt{windeployqt.exe}.
   If the installation directory for \textsl{Qt Creator} is
   \texttt{ProgramFiles} (e.g. \texttt{C:/Program Files}), then add
   these directories to the user or system PATH:

   \begin{verbatim}
      %ProgramFiles%\Qt\5.11.1\mingw53_32\bin
      %ProgramFiles%\Qt\Tools\mingw530_32\bin
   \end{verbatim}

   Obviously, the version number might differ from "5.11.1".
   There is a build script in the \texttt{nsis} directory that
   automates the process of making the executable:
   \texttt{build\_release\_package.bat}.
   It also shows the steps needed to do a release build and create a
   \textsl{7-Zip} package, which include editing some macro variables with
   naming or version information.  If one wants to do it manually,
   follow these steps.  (We denote the DOS backslash path separator
   by "/", for our convenience.)

   \begin{enumerate}
      \item Using
         "git clone https://github.com/ahlstromcj/seq66.git"
         or the unpacking of a source-code tarball,
         create the \texttt{seq66} directory with all
         of the project files.
      \item Change to the directory above this directory.
      \item Create an empty "shadow" directory, e.g. \texttt{seq66-release}.
      \item Change to this "shadow" directory.  In that directory, run the
         following command:
         \texttt{qmake -makefile -recursive "CONFIG += release"
            ../seq66/seq66.pro}.
      \item Next, run the following command and wait for the build to
         complete:
         \texttt{mingw32-make > make.log 2>\&1}.
      \item Open \texttt{make.log} and make sure there are no errors.
         Note that the output directory is inside the "shadow" directory and
         is called \texttt{Seq66qt5/release}.
      \item Run the following command to copy necessary \textsl{Qt} DLLs to
         this directory: \linebreak
         \texttt{windeployqt Seq66qt5/release}.
      \item Create the \texttt{data} directory in
         \texttt{windeployqt Seq66qt5/release} and copy some data files:
         \begin{enumerate}
            \item \texttt{mkdir Seq66qt5/release/data}
            \item \texttt{copy ../seq66/data/*.rc Seq66qt5/release/data}
            \item \texttt{copy ../seq66/data/*.usr Seq66qt5/release/data}
            \item \texttt{copy ../seq66/data/*.midi Seq66qt5/release/data}
            \item \texttt{copy ../seq66/data/*.pdf Seq66qt5/release/data}
            \item \texttt{copy ../seq66/data/*.txt Seq66qt5/release/data}
            \item \texttt{copy ../seq66/data/*.playlist Seq66qt5/release/data}
         \end{enumerate}
      \item Change to the \texttt{Seq66qt5} directory and run:
         \texttt{7z a -r qpseq66-release-package-0.96.1.7z \linebreak release/*}
   \end{enumerate}

   \index{portable package}
   At this point, the \texttt{7z} file is useful as a "portable" package
   for the application.  It can also be used to build the installer, as
   shown in the next section.

   By the way, we have not tried using the Microsoft C++ compiler yet.
   If you try it and get the code to work, let us know!

\subsubsection{Windows Installer}
\label{subsec:build_installer_windows}

   Here, we unpack the \texttt{7z} release package and then use
   \textsl{NSIS} to build the installer.
   These steps equire \textsl{7-Zip}
   to be installed and accessible from the DOS
   command-line, as \texttt{7z.exe}.
   Requires \textsl{NSIS 3} to be installed, unless one wants to use
   NSIS on Linux to build the installer (our preferred method).
   We build the installer in \textsl{Linux} using the
   \textsl{nsis} package.  These instructions can be adopted to using the
   \textsl{Windows} GUI interface for \textsl{NSIS}.

   \begin{enumerate}
      \item Copy the file
         \texttt{7z a -r qpseq66-release-package-0.96.1.7z} to
         the top-level project directory, \texttt{seq66}.
      \item Run
         \texttt{7z x qpseq66-release-package-0.96.1.7z} to extract
         the contents to the \texttt{release} directory.
      \item Run the following commands:
         \begin{enumerate}
            \item \texttt{pushd nsis}
            \item \texttt{makensis Seq66Setup.nsi}
            \item \texttt{popd}
         \end{enumerate}
      \item Verify that the installer works.  It's name is like:
         \texttt{seq66\_setup\_0.90.0.exe}
   \end{enumerate}

   The \textsl{bash} script \texttt{packages} does all this, plus
   creates the source-tarball and some other actions for the developers.

%-------------------------------------------------------------------------------
% vim: ts=3 sw=3 et ft=tex
%-------------------------------------------------------------------------------
